<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: 'Sarabun', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh; padding: 20px;
    }
    .container { max-width:1200px; margin:0 auto; background:white; border-radius:20px;
      box-shadow:0 20px 40px rgba(0,0,0,0.1); overflow:hidden; }
    .header { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color:#fff; padding:30px; text-align:center; }
    .header h1 { font-size:2.5rem; margin-bottom:10px; text-shadow:2px 2px 4px rgba(0, 0, 0, 0.3); }
    .main-content { padding:30px; }
    .form-section { background:#f8f9fa; border-radius:15px; padding:25px; margin-bottom:30px; border:2px solid #e9ecef; }
    .form-group { margin-bottom:20px; }
    label { display:block; font-weight:600; color:#333; margin-bottom:8px; font-size:1.05rem; }
    select, input[type="date"], input[type="file"] {
      width:100%; padding:12px 15px; border:2px solid #ddd; border-radius:10px; background:#fff; font-size:1rem; transition:.2s;
    }
    .status-buttons { display:flex; gap:12px; margin-top:10px; flex-wrap:wrap; }
    .status-btn { flex:1; min-width:140px; padding:12px 18px; border:2px solid #ddd; border-radius:10px; background:#fff; cursor:pointer;
      font-size:1rem; font-weight:600; text-align:center; transition:.2s; }
    .status-btn.pass { border-color:#28a745; color:#28a745; } .status-btn.pass.active { background:#28a745; color:#fff; }
    .status-btn.fail { border-color:#dc3545; color:#dc3545; } .status-btn.fail.active { background:#dc3545; color:#fff; }
    .submit-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:#fff; border:none; padding:14px 24px;
      border-radius:10px; font-size:1.05rem; font-weight:700; cursor:pointer; width:100%; margin-top:10px; }
    .nav-tabs { display:flex; background:#f8f9fa; border-radius:10px; padding:6px; margin-bottom:20px; gap:6px; flex-wrap:wrap; }
    .nav-tab { flex:1; min-width:180px; padding:12px 16px; text-align:center; background:transparent; border:none; border-radius:8px;
      cursor:pointer; font-weight:700; font-size:1rem; transition:.2s; color:#555; }
    .nav-tab.active { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color:#fff; box-shadow:0 2px 10px rgba(79,172,254,.3); }
    .tab-content { display:none; } .tab-content.active { display:block; }
    .records-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap:16px; margin-top:16px; }
    .record-card { background:#fff; border-radius:14px; padding:16px; border:2px solid #f0f0f0; box-shadow:0 5px 15px rgba(0,0,0,0.06); }
    .record-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
    .status-badge { padding:6px 10px; border-radius:20px; font-weight:700; font-size:.9rem; }
    .status-badge.pass { background:#d4edda; color:#155724; } .status-badge.fail { background:#f8d7da; color:#721c24; }
    .summary-table { width:100%; border-collapse:collapse; background:#fff; border-radius:14px; overflow:hidden; }
    .summary-table th { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:#fff; padding:12px; }
    .summary-table td { padding:10px; border-bottom:1px solid #f0f0f0; text-align:center; }
    .summary-stats { display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:14px; margin:16px 0 20px; }
    .stat-card { background:#fff; padding:18px; border-radius:14px; border:2px solid #f0f0f0; text-align:center; }
    .stat-number { font-size:2rem; font-weight:800; }
    .stat-total { color:#18d000; } .stat-pass { color:#28a745; } .stat-fail { color:#dc3545; } .stat-pending { color:#ffc107; }
    .actions-row { display:flex; gap:10px; flex-wrap:wrap; margin:10px 0 15px; }
    .btn { padding:10px 14px; border-radius:10px; border:none; cursor:pointer; font-weight:700; }
    .btn-danger { background:#dc3545; color:#fff; } .btn-secondary { background:#6c757d; color:#fff; } .btn-success { background:#28a745; color:#fff; }
    .btn-outline { background:#fff; border:2px solid #ddd; }
    .image-preview { width:50px; height:50px; object-fit:cover; border-radius:8px; border:2px solid #ddd; cursor:pointer; }
    .no-records { text-align:center; color:#666; padding:30px; }
    /* modal */
    .modal{ display:none; position:fixed; z-index:1000; inset:0; background:rgba(0,0,0,0.8); }
    .modal-content{ background:#fff; margin:5% auto; padding:20px; border-radius:14px; width:92%; max-width:720px; position:relative; }
    .close{ position:absolute; right:16px; top:10px; font-size:26px; cursor:pointer; color:#666; }
    .modal-image{ width:100%; max-height:420px; object-fit:contain; border-radius:8px; }
    @media (max-width: 768px){ .records-grid{ grid-template-columns:1fr; } .nav-tab{ min-width:auto; } }
  </style>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- SheetJS (XLSX) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- Socket.IO client -->
  <script src="/socket.io/socket.io.js"></script>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üìä ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö</h1>
      <p>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡πâ‡∏≠‡∏°‡∏ß‡∏±‡∏î‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£‡∏ô‡πâ‡∏≥</p>
    </div>

    <div class="main-content">
      <div class="nav-tabs">
        <button class="nav-tab active" onclick="switchTab(event,'add-record')">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        <button class="nav-tab" onclick="switchTab(event,'records-list')">üìã ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö</button>
        <button class="nav-tab" onclick="switchTab(event,'machine-history')">üîç ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</button>
        <button class="nav-tab" onclick="switchTab(event,'summary')">üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</button>
      </div>

      <!-- Add Record -->
      <div class="tab-content active" id="add-record">
        <div class="form-section">
          <h2 style="margin-bottom:14px;">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÉ‡∏´‡∏°‡πà</h2>
          <div class="form-group">
            <label for="machine-select">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡πâ‡∏≠‡∏°:</label>
            <select id="machine-select"></select>
          </div>
          <div class="form-group">
            <label for="calibration-date">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö:</label>
            <input type="date" id="calibration-date">
          </div>
          <div class="form-group">
            <label>‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö:</label>
            <div class="status-buttons">
              <div class="status-btn pass" onclick="selectStatus('pass')">‚úÖ ‡∏ú‡πà‡∏≤‡∏ô</div>
              <div class="status-btn fail" onclick="selectStatus('fail')">‚ùå ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô</div>
            </div>
          </div>
          <div class="form-group">
            <label for="image-upload">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û:</label>
            <input type="file" id="image-upload" accept="image/*">
          </div>
          <button class="submit-btn" onclick="addRecord()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        </div>
      </div>

      <!-- Records List -->
      <div class="tab-content" id="records-list">
        <h2 style="margin-bottom:10px;">üìã ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö</h2>
        <div class="records-grid" id="records-grid">
          <div class="no-records">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö</div>
        </div>
      </div>

      <!-- Machine History -->
      <div class="tab-content" id="machine-history">
        <h2 style="margin-bottom:10px;">üîç ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</h2>
        <div class="actions-row">
          <div class="form-group" style="min-width:260px; flex:1;">
            <label for="history-machine-select">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥:</label>
            <select id="history-machine-select" onchange="showMachineHistory()"></select>
          </div>
          <button class="btn btn-danger" onclick="bulkDelete()">‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</button>
          <button class="btn btn-secondary" onclick="exportExcel()">‚¨áÔ∏è ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô Excel</button>
        </div>

        <div id="machine-details" style="display:none;">
          <div style="background:#e3f2fd; border-left:5px solid #2196f3; border-radius:14px; padding:16px; margin-bottom:14px;">
            <h3 id="selected-machine-name" style="color:#1976d2; margin-bottom:8px;"></h3>
            <div style="display:flex; gap:20px; flex-wrap:wrap;">
              <div><strong>‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£‡∏ô‡πâ‡∏≥:</strong> <span id="selected-machine-volume"></span> ‡∏•‡∏¥‡∏ï‡∏£</div>
              <div><strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö:</strong> <span id="selected-machine-count"></span> ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div>
              <div><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î:</strong> <span id="selected-machine-status"></span></div>
            </div>
          </div>

          <canvas id="machineTrend" height="120" style="margin:10px 0 20px;"></canvas>

          <div style="overflow-x:auto;">
            <table class="summary-table" id="machine-history-table">
              <thead>
                <tr>
                  <th>‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà</th>
                  <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö</th>
                  <th>‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö</th>
                  <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</th>
                  <th>‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</th>
                  <th>‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                </tr>
              </thead>
              <tbody id="machine-history-tbody"></tbody>
            </table>
          </div>
        </div>

        <div id="no-machine-selected" class="no-records">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö</div>
      </div>

      <!-- Summary -->
      <div class="tab-content" id="summary">
        <h2 style="margin-bottom:10px;">üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö</h2>
        <div class="actions-row">
          <button class="btn btn-secondary" onclick="exportExcel()">‚¨áÔ∏è ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô Excel</button>
        </div>
        <div class="summary-stats">
          <div class="stat-card"><div class="stat-number stat-total" id="total-machines">0</div><div>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡πâ‡∏≠‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div></div>
          <div class="stat-card"><div class="stat-number stat-pass" id="passed-machines">0</div><div>‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö</div></div>
          <div class="stat-card"><div class="stat-number stat-fail" id="failed-machines">0</div><div>‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö</div></div>
          <div class="stat-card"><div class="stat-number stat-pending" id="pending-machines">0</div><div>‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö</div></div>
        </div>

        <div style="display:grid; grid-template-columns:1fr; gap:16px;">
          <canvas id="statusPie" height="120"></canvas>
          <canvas id="recordsByDay" height="140"></canvas>
        </div>

        <div style="margin-top:16px; overflow-x:auto;">
          <table class="summary-table" id="summary-table">
            <thead>
              <tr>
                <th>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡πâ‡∏≠‡∏°</th>
                <th>‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£ (‡∏•‡∏¥‡∏ï‡∏£)</th>
                <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th>
                <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th>
                <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö</th>
              </tr>
            </thead>
            <tbody id="summary-tbody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Modal -->
    <div id="recordModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h2 id="modal-title">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö</h2>
        <div id="modal-body"></div>
      </div>
    </div>
  </div>

  <script>
    // Machine master
    const machines = {
      'DD50-1': 800, 'DD50-2': 800, 'DD100': 900, 'DD200-1': 1800, 'DD200-2': 1800, 'DD600': 3960,
      'DL2-1': 16, 'DL500-1': 5, 'DL500-2': 5, 'DL500-3': 5, 'DL500-4': 5,
      'DL250-1': 3.5, 'DL250-2': 3.5, 'DL250-3': 3.5, 'DL250-4': 3.5,
      'DL125-1': 2, 'DL125-2': 2, 'DL125-3': 2, 'DL125-4': 2,
      'RK3-1': 26, 'RK3-2': 26, 'RK3-3': 26, 'RK3-4': 26, 'RK3-5': 26, 'RK3-6': 26,
      'RK6-1': 44, 'RK6-2': 44, 'RK6-3': 44, 'RK6-4': 44, 'RK6-5': 44, 'RK6-6': 44,
      'LX4': 60, 'LX5': 60, 'LX6': 60, 'LX7': 60, 'LX8': 60, 'LX9': 60, 'LX10': 60, 'LX11': 60, 'LX12': 60, 'LX13': 60, 'LX14': 60, 'LX15': 60, 'LX16': 60, 'LX17': 60,
      'A5': 225, 'B6': 225, 'B7': 225, 'A4': 145, 'B1': 225, 'B5': 145
    };

    let selectedStatus = '';
    let records = [];
    let statusPieChart = null;
    let recordsByDayChart = null;
    let machineTrendChart = null;

    // Socket.IO: realtime updates
    const socket = io();
    socket.on('records-updated', () => {
      loadRecords(); // refresh on any change
    });

    function initializeMachines() {
      const select = document.getElementById('machine-select');
      const historySelect = document.getElementById('history-machine-select');
      select.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡πâ‡∏≠‡∏° --</option>';
      historySelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡πâ‡∏≠‡∏° --</option>';
      Object.keys(machines).forEach(machine => {
        const opt = new Option(machine, machine);
        const opt2 = new Option(machine, machine);
        select.add(opt);
        historySelect.add(opt2);
      });
    }

    function selectStatus(status) {
      selectedStatus = status;
      document.querySelectorAll('.status-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelector(`.status-btn.${status}`).classList.add('active');
    }

    async function loadRecords() {
      try {
        const res = await fetch('/api/records');
        const data = await res.json();
        records = data.map(rec => ({
          id: rec._id, machine: rec.machine, volume: rec.volume, date: rec.date,
          status: rec.status, image: rec.image || null, timestamp: rec.timestamp
        }));
        records.sort((a,b)=> new Date(b.date) - new Date(a.date));
        renderRecords();
        if (document.getElementById('summary').classList.contains('active')) {
          updateSummary();
          buildSummaryCharts();
        }
        if (document.getElementById('machine-history').classList.contains('active')) {
          showMachineHistory(); // keep current view in sync
        }
      } catch (e) {
        console.error('loadRecords', e);
      }
    }

    function addRecord() {
      const machine = document.getElementById('machine-select').value;
      const date = document.getElementById('calibration-date').value;
      const file = document.getElementById('image-upload').files[0];
      if (!machine || !date || !selectedStatus) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô'); return; }

      const fd = new FormData();
      fd.append('machine', machine);
      fd.append('volume', machines[machine]);
      fd.append('date', date);
      fd.append('status', selectedStatus);
      fd.append('timestamp', new Date().toLocaleString('th-TH'));
      if (file) fd.append('image', file);

      fetch('/api/records', { method:'POST', body:fd })
        .then(r=>r.json())
        .then(()=> {
          clearForm();
          // no need to push to local; server will emit socket event and reload
        })
        .catch(err=> { console.error(err); alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'); });
    }

    function renderRecords() {
      const grid = document.getElementById('records-grid');
      if (!records.length) { grid.innerHTML = '<div class="no-records">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö</div>'; return; }
      grid.innerHTML = records.map(r => `
        <div class="record-card">
          <div class="record-header">
            <div style="font-weight:800;">${r.machine}</div>
            <div class="status-badge ${r.status}">${r.status==='pass'?'‡∏ú‡πà‡∏≤‡∏ô':'‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô'}</div>
          </div>
          <div style="line-height:1.6;">
            <div><strong>‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£:</strong> ${r.volume} ‡∏•‡∏¥‡∏ï‡∏£</div>
            <div><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö:</strong> ${new Date(r.date).toLocaleDateString('th-TH')}</div>
            <div><strong>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠:</strong> ${r.timestamp}</div>
          </div>
          ${r.image ? `<img class="image-preview" style="width:100%;height:200px;margin-top:10px;object-fit:cover;border-radius:10px;" src="${r.image}" onclick="showImageModal('${r.image}')">` : ''}
        </div>
      `).join('');
    }

    function clearForm() {
      document.getElementById('machine-select').value = '';
      document.getElementById('calibration-date').value = '';
      document.getElementById('image-upload').value = '';
      selectedStatus = '';
      document.querySelectorAll('.status-btn').forEach(btn => btn.classList.remove('active'));
    }

    function showMachineHistory() {
      const selectedMachine = document.getElementById('history-machine-select').value;
      const details = document.getElementById('machine-details');
      const noSel = document.getElementById('no-machine-selected');
      if (!selectedMachine) { details.style.display='none'; noSel.style.display='block'; return; }
      details.style.display='block'; noSel.style.display='none';

      const mRecs = records.filter(r => r.machine === selectedMachine);
      const sorted = [...mRecs].sort((a,b)=> new Date(a.date) - new Date(b.date));
      const latest = sorted[sorted.length-1];

      document.getElementById('selected-machine-name').textContent = selectedMachine;
      document.getElementById('selected-machine-volume').textContent = machines[selectedMachine];
      document.getElementById('selected-machine-count').textContent = mRecs.length;
      document.getElementById('selected-machine-status').innerHTML = latest
        ? (latest.status==='pass' ? '<span class="stat-pass">‚úÖ ‡∏ú‡πà‡∏≤‡∏ô</span>' : '<span class="stat-fail">‚ùå ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô</span>')
        : '<span class="stat-pending">‚è≥ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡∏≠‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö</span>';

      // table
      const tbody = document.getElementById('machine-history-tbody');
      if (!mRecs.length) {
        tbody.innerHTML = '<tr><td colspan="6" style="padding:20px;color:#666;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ</td></tr>';
      } else {
        const desc = [...mRecs].sort((a,b)=> new Date(b.date) - new Date(a.date));
        tbody.innerHTML = desc.map((r,i)=> `
          <tr>
            <td>${desc.length - i}</td>
            <td>${new Date(r.date).toLocaleDateString('th-TH')}</td>
            <td>${r.status==='pass'?'‚úÖ ‡∏ú‡πà‡∏≤‡∏ô':'‚ùå ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô'}</td>
            <td style="font-size:.9rem;color:#666;">${r.timestamp}</td>
            <td>${r.image ? `<img class="image-preview" src="${r.image}" onclick="showImageModal('${r.image}')">` : '-'}</td>
            <td>
              <button class="btn btn-outline" onclick="viewRecordDetails('${r.id}')">‡∏î‡∏π</button>
              <button class="btn btn-danger" onclick="deleteRecord('${r.id}')">‡∏•‡∏ö</button>
            </td>
          </tr>
        `).join('');
      }

      // chart: status over time (1 for pass, 0 for fail)
      const labels = sorted.map(r => new Date(r.date).toLocaleDateString('th-TH'));
      const values = sorted.map(r => r.status === 'pass' ? 1 : 0);
      if (machineTrendChart) machineTrendChart.destroy();
      const ctx = document.getElementById('machineTrend').getContext('2d');
      machineTrendChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: '‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (1=‡∏ú‡πà‡∏≤‡∏ô, 0=‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô)',
            data: values,
            fill: false,
            tension: 0.2,
            pointRadius: 3
          }]
        },
        options: {
          scales: {
            y: { suggestedMin: -0.1, suggestedMax: 1.1, ticks: { stepSize: 1 } }
          }
        }
      });
    }

    function viewRecordDetails(id) {
      const r = records.find(x => x.id === id);
      if (!r) return;
      document.getElementById('modal-title').textContent = `‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö - ${r.machine}`;
      document.getElementById('modal-body').innerHTML = `
        <div style="line-height:1.8;">
          <p><strong>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠:</strong> ${r.machine}</p>
          <p><strong>‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£:</strong> ${r.volume} ‡∏•‡∏¥‡∏ï‡∏£</p>
          <p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö:</strong> ${new Date(r.date).toLocaleDateString('th-TH')}</p>
          <p><strong>‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö:</strong> ${r.status==='pass'?'‚úÖ ‡∏ú‡πà‡∏≤‡∏ô':'‚ùå ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô'}</p>
          <p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å:</strong> ${r.timestamp}</p>
          ${r.image ? `<div style="margin-top:10px;"><img class="modal-image" src="${r.image}"></div>` : ''}
        </div>`;
      document.getElementById('recordModal').style.display = 'block';
    }

    function showImageModal(src) {
      document.getElementById('modal-title').textContent = '‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö';
      document.getElementById('modal-body').innerHTML = `<img class="modal-image" src="${src}">`;
      document.getElementById('recordModal').style.display = 'block';
    }

    function closeModal() { document.getElementById('recordModal').style.display='none'; }
    window.addEventListener('click', (e)=> {
      const modal = document.getElementById('recordModal');
      if (e.target === modal) closeModal();
    });

    function deleteRecord(id) {
      if (!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ?')) return;
      fetch(`/api/records/${id}`, { method:'DELETE' })
        .then(res => { if (!res.ok) throw new Error('delete failed'); })
        .catch(err => { console.error(err); alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö'); });
    }

    function bulkDelete() {
      const m = document.getElementById('history-machine-select').value;
      if (!m) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á'); return; }
      if (!confirm(`‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á ${m}?`)) return;
      fetch(`/api/records?machine=${encodeURIComponent(m)}`, { method:'DELETE' })
        .then(res => res.json())
        .then(resp => { alert(resp.message || '‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß'); })
        .catch(err => { console.error(err); alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÅ‡∏ö‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°'); });
    }

    // SUMMARY + CHARTS
    function updateSummary() {
      const totalMachines = Object.keys(machines).length;
      const statusByMachine = {};
      Object.keys(machines).forEach(m => statusByMachine[m] = { machine:m, volume:machines[m], status:'pending', lastDate:'-', count:0 });

      records.forEach(r => {
        const cur = statusByMachine[r.machine];
        if (cur) {
          cur.count++;
          if (cur.lastDate === '-' || new Date(r.date) > new Date(cur.lastDate)) {
            cur.lastDate = r.date;
            cur.status = r.status;
          }
        }
      });

      let pass=0, fail=0, pending=0;
      Object.values(statusByMachine).forEach(m => {
        if (m.status === 'pass') pass++; else if (m.status === 'fail') fail++; else pending++;
      });

      document.getElementById('total-machines').textContent = totalMachines;
      document.getElementById('passed-machines').textContent = pass;
      document.getElementById('failed-machines').textContent = fail;
      document.getElementById('pending-machines').textContent = pending;

      const tbody = document.getElementById('summary-tbody');
      tbody.innerHTML = Object.values(statusByMachine).map(m => `
        <tr>
          <td style="text-align:left;font-weight:700;">${m.machine}</td>
          <td>${m.volume}</td>
          <td>${m.status==='pass'?'‚úÖ ‡∏ú‡πà‡∏≤‡∏ô': m.status==='fail'?'‚ùå ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô':'‚è≥ ‡∏£‡∏≠‡∏™‡∏≠‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö'}</td>
          <td>${m.lastDate==='-'?'-': new Date(m.lastDate).toLocaleDateString('th-TH')}</td>
          <td>${m.count}</td>
        </tr>
      `).join('');
    }

    function buildSummaryCharts() {
      // Pie: counts by latest status across machines
      const pass = +document.getElementById('passed-machines').textContent;
      const fail = +document.getElementById('failed-machines').textContent;
      const pending = +document.getElementById('pending-machines').textContent;
      const pieCtx = document.getElementById('statusPie').getContext('2d');
      if (statusPieChart) statusPieChart.destroy();
      statusPieChart = new Chart(pieCtx, {
        type:'pie',
        data:{ labels:['‡∏ú‡πà‡∏≤‡∏ô','‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô','‡∏£‡∏≠‡∏™‡∏≠‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö'], datasets:[{ data:[pass, fail, pending] }] },
        options:{ plugins:{ legend:{ position:'bottom' } } }
      });

      // Line: records per day
      const byDay = {};
      records.forEach(r => {
        const d = new Date(r.date); const key = d.toISOString().slice(0,10);
        byDay[key] = (byDay[key] || 0) + 1;
      });
      const dates = Object.keys(byDay).sort();
      const values = dates.map(k => byDay[k]);
      const lineCtx = document.getElementById('recordsByDay').getContext('2d');
      if (recordsByDayChart) recordsByDayChart.destroy();
      recordsByDayChart = new Chart(lineCtx, {
        type:'line',
        data:{ labels: dates.map(d => new Date(d).toLocaleDateString('th-TH')), datasets:[{ label:'‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô', data: values, fill:false, tension:0.2, pointRadius:3 }] },
        options:{ plugins:{ legend:{ display:true } }, scales:{ y:{ beginAtZero:true } } }
      });
    }

    function exportExcel() {
      // Sheet: Records
      const recs = records.map(r => ({
        id: r.id, ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á: r.machine, ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£‡∏•‡∏¥‡∏ï‡∏£: r.volume, ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö: r.date, ‡∏ú‡∏•: r.status, ‡πÄ‡∏ß‡∏•‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: r.timestamp, ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û: r.image || ''
      }));
      const ws1 = XLSX.utils.json_to_sheet(recs);

      // Sheet: Summary (latest status per machine)
      const statusByMachine = {};
      Object.keys(machines).forEach(m => statusByMachine[m] = { ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á:m, ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£‡∏•‡∏¥‡∏ï‡∏£:machines[m], ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î:'pending', ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î:'-', ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á:0 });
      records.forEach(r => {
        const cur = statusByMachine[r.machine];
        if (!cur) return;
        cur.‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á++;
        if (cur.‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î === '-' || new Date(r.date) > new Date(cur.‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)) {
          cur.‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î = r.date;
          cur.‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î = r.status;
        }
      });
      const ws2 = XLSX.utils.json_to_sheet(Object.values(statusByMachine));

      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws1, 'Records');
      XLSX.utils.book_append_sheet(wb, ws2, 'Summary');
      XLSX.writeFile(wb, `calibration-export-${new Date().toISOString().slice(0,10)}.xlsx`);
    }

    function switchTab(evt, tabName) {
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.nav-tab').forEach(b => b.classList.remove('active'));
      document.getElementById(tabName).classList.add('active');
      evt.target.classList.add('active');
      if (tabName==='summary') { updateSummary(); buildSummaryCharts(); }
      if (tabName==='machine-history') {
        document.getElementById('history-machine-select').value = '';
        document.getElementById('machine-details').style.display = 'none';
        document.getElementById('no-machine-selected').style.display = 'block';
      }
    }

    // Init
document.addEventListener('DOMContentLoaded', () => {
  try { initializeMachines(); } catch(e) { console.error('init machines', e); }
  try { loadRecords(); } catch(e) { console.error('load records', e); }
});
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  try {
    if (window.io) {
      const s = window.io();
      window.__socket = s;
      s.on('records-updated', () => { loadRecords(); });
    } else {
      console.warn('Socket.IO client not found, running without realtime.');
    }
  } catch (err) { console.warn('Socket.IO init failed:', err); }
  try { initializeMachines(); loadRecords(); } catch (e) { console.error('Init error:', e); }
});
</script>
</body>
</html>
